name: Build and Push Docker Images to Both Registries

on:
  push:
    paths:
      - '**/Dockerfile*'
      - '**/*.py'
      - '**/*.sh'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: ${{ secrets.DOCKER_NAMESPACE != '' && secrets.DOCKER_PASSWORD != '' }}
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKER_NAMESPACE }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Log in to GHCR
        if: ${{ secrets.GHCR_NAMESPACE != '' && secrets.GHCR_PAT != '' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.GHCR_NAMESPACE }} # **ç™»å½•ç”¨æˆ·å**ï¼šä½¿ç”¨ Secret
          password: ${{ secrets.GHCR_PAT }} # ä½¿ç”¨ GHCR PAT Secret

      - name: Detect changed services
        id: changes
        run: |
          git fetch origin ${{ github.event.before }}
          CHANGED_DIRS=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | \
            awk -F/ '{print $1}' | sort -u)

          SERVICES=""
          for dir in $CHANGED_DIRS; do
            if ls "$dir"/Dockerfile* 1> /dev/null 2>&1; then
              SERVICES="$SERVICES $dir"
            fi
          done

          echo "services=$SERVICES" >> "$GITHUB_OUTPUT"

      - name: Build Docker images (without pushing)
        # ä»…æ„å»ºï¼Œä¸ç«‹å³æ¨é€
        if: steps.changes.outputs.services != ''
        id: buildonly
        run: |
          for dir in ${{ fromJson(steps.changes.outputs.services) }}; do
            for file in "$dir"/Dockerfile*; do
              [ -f "$file" ] || continue
              base=$(basename "$file")
              service=$(basename "$dir")

              if [[ "$base" == "Dockerfile" ]]; then
                tag="latest"
              else
                tag="${base#Dockerfile_}"
              fi

              echo "ğŸ“¦ Building $service:$tag from $file..."

              docker buildx build \
                --file "$file" \
                --platform linux/amd64,linux/arm64 \
                --cache-from type=gha,scope=$service \
                --cache-to type=gha,mode=max,scope=$service \
                --progress=plain \
                -t "${{ secrets.DOCKER_NAMESPACE }}/$service:$tag" \
                -t "ghcr.io/${{ env.GHCR_ORG_NAMESPACE }}/$service:$tag" \ # **å…³é”®æ›´æ”¹**ï¼šæ„å»ºæ—¶ä½¿ç”¨ env.GHCR_ORG_NAMESPACE
                "$dir"
            done
          done

      - name: Push Docker images to Docker Hub
        # ä»…å½“ Docker Hub å‡­æ®å­˜åœ¨ä¸”æœ‰æœåŠ¡è¢«æ„å»ºæ—¶æ‰æ‰§è¡Œ
        if: ${{ secrets.DOCKER_NAMESPACE != '' && secrets.DOCKER_PASSWORD != '' && steps.changes.outputs.services != '' }}
        id: push_docker_hub
        run: |
          IMAGES_PUSHED=()
          for dir in ${{ fromJson(steps.changes.outputs.services) }}; do
            for file in "$dir"/Dockerfile*; do
              [ -f "$file" ] || continue
              base=$(basename "$file")
              service=$(basename "$dir")

              if [[ "$base" == "Dockerfile" ]]; then
                tag="latest"
              else
                tag="${base#Dockerfile_}"
              fi
              image="${{ secrets.DOCKER_NAMESPACE }}/$service:$tag"
              echo "â¬†ï¸ Pushing $image to Docker Hub..."
              docker push "$image"
              IMAGES_PUSHED+=("$image")
            done
          done
          echo "docker_hub_images=${IMAGES_PUSHED[*]}" >> "$GITHUB_OUTPUT"

      - name: Push Docker images to GHCR
        # ä»…å½“ GHCR å‡­æ®å­˜åœ¨ä¸”æœ‰æœåŠ¡è¢«æ„å»ºæ—¶æ‰æ‰§è¡Œ
        if: ${{ env.GHCR_ORG_NAMESPACE != '' && secrets.GHCR_PAT != '' && secrets.GHCR_NAMESPACE != '' && steps.changes.outputs.services != '' }} # å¢åŠ å¯¹ secrets.GHCR_NAMESPACE çš„æ£€æŸ¥
        id: push_ghcr
        run: |
          IMAGES_PUSHED=()
          for dir in ${{ fromJson(steps.changes.outputs.services) }}; do
            for file in "$dir"/Dockerfile*; do
              [ -f "$file" ] || continue
              base=$(basename "$file")
              service=$(basename "$dir")

              if [[ "$base" == "Dockerfile" ]]; then
                tag="latest"
              else
                tag="${base#Dockerfile_}"
              fi
              image="ghcr.io/${{ env.GHCR_ORG_NAMESPACE }}/$service:$tag" # **å…³é”®æ›´æ”¹**ï¼šæ¨é€æ—¶ä½¿ç”¨ env.GHCR_ORG_NAMESPACE
              echo "â¬†ï¸ Pushing $image to GHCR..."
              docker push "$image"
              IMAGES_PUSHED+=("$image")
            done
          done
          echo "ghcr_images=${IMAGES_PUSHED[*]}" >> "$GITHUB_OUTPUT"

      - name: Show pushed images summary
        # æ˜¾ç¤ºæ‰€æœ‰æˆåŠŸæ¨é€çš„é•œåƒ
        if: steps.buildonly.outcome == 'success'
        run: |
          echo "--- æ¨é€ç»“æœæ€»ç»“ ---"
          if [[ -n "${{ steps.push_docker_hub.outputs.docker_hub_images }}" ]]; then
            echo "âœ… å·²æ¨é€åˆ° Docker Hub:"
            echo "${{ steps.push_docker_hub.outputs.docker_hub_images }}" | tr ' ' '\n'
          else
            echo "âŒ æœªæ¨é€åˆ° Docker Hub (å¯èƒ½æœªé…ç½®æˆ–æ— å˜åŒ–)"
          fi
          echo ""
          if [[ -n "${{ steps.push_ghcr.outputs.ghcr_images }}" ]]; then
            echo "âœ… å·²æ¨é€åˆ° GHCR:"
            echo "${{ steps.push_ghcr.outputs.ghcr_images }}" | tr ' ' '\n'
          else
            echo "âŒ æœªæ¨é€åˆ° GHCR (å¯èƒ½æœªé…ç½®æˆ–æ— å˜åŒ–)"
          fi
          echo "--------------------"