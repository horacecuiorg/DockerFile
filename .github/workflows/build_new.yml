# This is a basic workflow to help you get started with Actions

name: build

on:
  push:
    paths:
      - '**/Dockerfile'
      - '**/*.py'
      - '**/*.sh'
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Aliyun ACR
        run: |
          echo "${{ secrets.ALIYUN_PASSWORD }}" | docker login ${{ vars.ALIYUN_REGISTRY }} \
            --username ${{ secrets.ALIYUN_USERNAME }} --password-stdin

      - name: Log in to Docker hub
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login \
            --username ${{ secrets.DOCKER_NAMESPACE }} --password-stdin

      - name: Get current date
        id: date
        run: echo "tag=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Detect changed services
        id: changes
        run: |
          git fetch origin ${{ github.event.before }}
          CHANGED_DIRS=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | \
            awk -F/ '{print $1}' | sort -u)

          SERVICES=""
          for dir in $CHANGED_DIRS; do
            if [ -f "$dir/Dockerfile" ]; then
              SERVICES="$SERVICES $dir"
            fi
          done
          for svc in $SERVICES; do
            echo "âœ” Service to build: $svc"
          done
          echo "services=$SERVICES" >> $GITHUB_OUTPUT
          
      - name: Build and push Docker images to ACR
        if: steps.changes.outputs.services != ''
        run: |
          for service in ${{ steps.changes.outputs.services }}; do
            DATE_TAG=${{ steps.date.outputs.tag }}
            IMAGE_NAME1=registry.cn-shanghai.aliyuncs.com/${{ secrets.DOCKER_NAMESPACE }}/$service
            IMAGE_NAME2=${{ secrets.DOCKER_NAMESPACE }}/$service
            echo "Building and pushing $IMAGE_NAME1:$DATE_TAG and $IMAGE_NAME1:latest..."
            echo "Building and pushing $IMAGE_NAME2:$DATE_TAG and $IMAGE_NAME2:latest..."

            docker build -t $IMAGE_NAME1:$DATE_TAG -t $IMAGE_NAME1:latest -t $IMAGE_NAME2:$DATE_TAG -t $IMAGE_NAME2:latest  $service
            docker push $IMAGE_NAME1:$DATE_TAG
            docker push $IMAGE_NAME1:latest
            docker push $IMAGE_NAME2:$DATE_TAG
            docker push $IMAGE_NAME2:latest
          done

              
